# ---------------- Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø°ÙƒÙŠØ© (ØªØ­Ù„ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„) ----------------
def send_email_to_professor(prof_name, memo_info, student1, student2=None):
    """Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø£Ø³ØªØ§Ø° (Ù†Ø³Ø®Ø© Ø°ÙƒÙŠØ© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ø®ØªÙ„Ø§ÙØ§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)"""
    try:
        # 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        df_prof_memos = load_prof_memos()
        
        # 2. Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø±Ù† Ø¹Ù† Ø§Ù„Ø£Ø³ØªØ§Ø°
        # Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ ØªÙ…Ø§Ù…Ø§Ù‹
        prof_row = df_prof_memos[df_prof_memos["Ø§Ù„Ø£Ø³ØªØ§Ø°"].astype(str).str.strip() == prof_name.strip()]
        
        # Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ØŒ Ù†Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø£Ø³Ù… Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ø§Ø³Ù… (Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ø®ØªÙ„Ø§Ù Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨)
        if prof_row.empty:
            # Ù†Ø­Ø°Ù Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨ Ø§Ù„Ø´Ø§Ø¦Ø¹Ø© "Ø§Ù„Ø£Ø³ØªØ§Ø°"ØŒ "Ø¯."ØŒ "Ø£.Ø¯" Ù„Ù„Ù…Ø­Ø§ÙˆÙ„Ø©
            clean_name = prof_name.strip().replace("Ø§Ù„Ø£Ø³ØªØ§Ø°", "").replace("Ø¯.", "").replace("Ø£.Ø¯", "").strip()
            if clean_name:
                prof_row = df_prof_memos[df_prof_memos["Ø§Ù„Ø£Ø³ØªØ§Ø°"].astype(str).str.contains(clean_name, case=False, na=False)]
        
        if prof_row.empty:
            error_msg = f"ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù„Ù„Ø£Ø³ØªØ§Ø° <b>{prof_name}</b>.<br>ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ø³Ù…Ù‡ ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ù…Ø°ÙƒØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§ØªØ°Ø©."
            logger.error(f"Email Error: Professor {prof_name} not found in Prof Memos sheet.")
            return False, error_msg

        # Ø£Ø®Ø° Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ (Ø¥Ø°Ø§ ÙˆØ¬Ø¯Ù†Ø§ ØªØ·Ø§Ø¨Ù‚ Ø¬Ø²Ø¦ÙŠ)
        prof_data = prof_row.iloc[0]
        
        # 3. Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø°ÙƒÙŠ Ø¹Ù† Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
        prof_email = ""
        possible_email_cols = ["Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", "Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„", "email", "Email"]
        for col in possible_email_cols:
            if col in prof_data.index:
                val = str(prof_data[col]).strip()
                if val and val != "nan":
                    prof_email = val
                    break
        
        if "@" not in prof_email:
            error_msg = f"ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: Ø§Ù„Ø£Ø³ØªØ§Ø° <b>{prof_name}</b> Ù…ÙˆØ¬ÙˆØ¯ØŒ ÙˆÙ„ÙƒÙ† Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙØ§Ø±Øº Ø£Ùˆ ØºÙŠØ± ØµØ­ÙŠØ­.<br>Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯: {prof_data.get('Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ', prof_data.get('Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„', 'ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯'))}"
            logger.error(f"Email Error: Invalid email for Prof {prof_name}: {prof_email}")
            return False, error_msg

        # 4. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
        total_memos = len(prof_row)
        registered_memos = len(prof_row[prof_row["ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„"].astype(str).str.strip() == "Ù†Ø¹Ù…"])
        remaining_memos = total_memos - registered_memos
        
        used_passwords = []
        available_passwords = []
        
        for idx, row in prof_row.iterrows():
            password = str(row.get("ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„ØªØ³Ø¬ÙŠÙ„", "")).strip()
            if password:
                if str(row.get("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„", "")).strip() == "Ù†Ø¹Ù…":
                    used_passwords.append(f"âœ… {password}")
                else:
                    available_passwords.append(f"â³ {password}")
        
        # 5. ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨
        s1_lname = student1.get('Ù„Ù‚Ø¨', student1.get('Ø§Ù„Ù„Ù‚Ø¨', ''))
        s1_fname = student1.get('Ø¥Ø³Ù…', student1.get('Ø¥Ø³Ù…', ''))
        student2_info = ""
        
        if student2 is not None:
            s2_lname = student2.get('Ù„Ù‚Ø¨', student2.get('Ø§Ù„Ù„Ù‚Ø¨', ''))
            s2_fname = student2.get('Ø¥Ø³Ù…', student2.get('Ø¥Ø³Ù…', ''))
            student2_info = f"\nğŸ‘¤ **Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ:** {s2_lname} {s2_fname}"
        
        passwords_list = "\n".join(used_passwords + available_passwords) if (used_passwords or available_passwords) else "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ„Ù…Ø§Øª Ø³Ø± Ù…Ø³Ø¬Ù„Ø©"
        
        # 6. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
        email_body = f"""
<html dir="rtl">
<head>
    <style>
        body {{ font-family: 'Arial', sans-serif; background-color: #f4f4f4; padding: 20px; }}
        .container {{ background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); max-width: 600px; margin: auto; }}
        .header {{ background-color: #256D85; color: white; padding: 20px; border-radius: 8px; text-align: center; margin-bottom: 20px; }}
        .header h2 {{ margin: 0; }}
        .content {{ line-height: 1.8; color: #333; }}
        .info-box {{ background-color: #f8f9fa; padding: 15px; border-right: 4px solid #256D85; margin: 15px 0; }}
        .stats-box {{ background-color: #e8f4f8; padding: 15px; border-radius: 8px; margin: 15px 0; }}
        .footer {{ text-align: center; color: #888; font-size: 12px; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; }}
        .highlight {{ color: #256D85; font-weight: bold; }}
        ul {{ list-style: none; padding: 0; }}
        li {{ padding: 5px 0; }}
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h2>âœ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        </div>
        
        <div class="content">
            <p>ØªØ­ÙŠØ© Ø·ÙŠØ¨Ø© ÙˆØ¨Ø¹Ø¯ : Ø§Ù„Ø£Ø³ØªØ§Ø°(Ø©) Ø§Ù„ÙØ§Ø¶Ù„(Ø©) <span class="highlight">{prof_name}</span>ØŒ</p>
            
            <p>Ù†Ø­ÙŠØ·ÙƒÙ… Ø¹Ù„Ù…Ø§Ù‹ Ø¨Ø£Ù†Ù‡ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© ØªØ­Øª Ø¥Ø´Ø±Ø§ÙÙƒÙ…:</p>
            
            <div class="info-box">
                <p>ğŸ“„ <strong>Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©:</strong> {memo_info['Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©']}</p>
                <p>ğŸ“‘ <strong>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø°ÙƒØ±Ø©:</strong> {memo_info['Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ø°ÙƒØ±Ø©']}</p>
                <p>ğŸ“ <strong>Ø§Ù„ØªØ®ØµØµ:</strong> {memo_info['Ø§Ù„ØªØ®ØµØµ']}</p>
                <p>ğŸ‘¤ <strong>Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø£ÙˆÙ„:</strong> {s1_lname} {s1_fname}{student2_info}</p>
                <p>ğŸ•’ <strong>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</strong> {datetime.now().strftime('%Y-%m-%d %H:%M')}</p>
            </div>
            
            <div class="stats-box">
                <h3 style="color: #256D85; margin-top: 0;">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ø°ÙƒØ±Ø§ØªÙƒ:</h3>
                <ul>
                    <li>ğŸ“ <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø°ÙƒØ±Ø§Øª:</strong> {total_memos}</li>
                    <li>âœ… <strong>Ø§Ù„Ù…Ø°ÙƒØ±Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:</strong> {registered_memos}</li>
                    <li>â³ <strong>Ø§Ù„Ù…Ø°ÙƒØ±Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</strong> {remaining_memos}</li>
                </ul>
            </div>
            
            <div class="info-box">
                <h3 style="color: #256D85; margin-top: 0;">ğŸ”‘ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ø³Ø±:</h3>
                <ul style="white-space: pre-line;">{passwords_list}</ul>
            </div>
            
            <p style="margin-top: 20px; color: #666;">Ù„Ù„Ø§Ø³ØªÙØ³Ø§Ø± Ø£Ùˆ Ø§Ù„Ø¯Ø¹Ù…ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø³ÙŠØ¯ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…ÙŠØ¯Ø§Ù† Ø§Ù„Ø¯ÙƒØªÙˆØ± Ø±ÙØ§Ù Ù„Ø®Ø¶Ø±.</p>
        </div>
        
        <div class="footer">
            <p>Â© 2026 Ø¬Ø§Ù…Ø¹Ø© Ù…Ø­Ù…Ø¯ Ø§Ù„Ø¨Ø´ÙŠØ± Ø§Ù„Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…ÙŠ</p>
            <p>ÙƒÙ„ÙŠØ© Ø§Ù„Ø­Ù‚ÙˆÙ‚ ÙˆØ§Ù„Ø¹Ù„ÙˆÙ… Ø§Ù„Ø³ÙŠØ§Ø³ÙŠØ©</p>
        </div>
    </div>
</body>
</html>
"""
        
        msg = MIMEMultipart('alternative')
        msg['From'] = EMAIL_SENDER
        msg['To'] = prof_email
        msg['Subject'] = f"âœ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø°ÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø© - Ø±Ù‚Ù… {memo_info['Ø±Ù‚Ù… Ø§Ù„Ù…Ø°ÙƒØ±Ø©']}"
        
        html_part = MIMEText(email_body, 'html', 'utf-8')
        msg.attach(html_part)
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
        with smtplib.SMTP(SMTP_SERVER, SMTP_PORT) as server:
            server.starttls()
            server.login(EMAIL_SENDER, EMAIL_PASSWORD)
            server.send_message(msg)
        
        logger.info(f"âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø¨Ø±ÙŠØ¯ Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù„Ù„Ø£Ø³ØªØ§Ø° {prof_name} Ø¹Ù„Ù‰ {prof_email}")
        return True, "ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ø¨Ù†Ø¬Ø§Ø­"
        
    except Exception as e:
        logger.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: {str(e)}")
        return False, f"Ø®Ø·Ø£ ØªÙ‚Ù†ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„: {str(e)}"